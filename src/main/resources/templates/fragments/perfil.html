<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body th:fragment="copy">


<!-- Title Panel -->
<div class="title-panel center">
    <span>Mi Perfil</span>
</div>

<div class="container">
    <div class="row">
        <div class="col s12">

            <ul class="collapsible" data-collapsible="expandable">

                <li>
                    <div class="collapsible-header active"><i class="material-icons">perm_identity</i> Mis Datos</div>
                    <div class="collapsible-body">
                        <div class="row">
                            <div class="col s12 m6">
                                <label> Username :
                                    <input type="text" id="username" name="username" th:value="${#authentication.principal.username}"/>
                                </label>
                            </div>
                            <div class="col s12 m6">
                                <label> Email :
                                    <input type="text" id="email"  name="email" th:value="${#authentication.principal.email}"/>
                                </label>
                            </div>
                        </div>

                        <div class="row">
                            <a id="btn-modificar-datos" class="btn-flat right blue-text">GUARDAR</a>
                        </div>
                    </div>
                </li>

                <li>
                    <div class="collapsible-header active"><i class="material-icons">vpn_key</i> Mi Contraseña</div>
                    <div class="collapsible-body">
                        <div class="row">
                            <div class="col s12 m4">
                                <label> Contraseña actual:
                                    <input type="password" id="currentPassword" name="currentPassword" />
                                </label>
                            </div>
                            <div class="col s12 m4">
                                <label> Nueva contraseña:
                                    <input type="password" id="newPassword" name="newPassword" />
                                </label>
                            </div>
                            <div class="col s12 m4">
                                <label> Repetir nueva contraseña:
                                    <input type="password" id="repeatedNewPassword" name="repeatedNewPassword" />
                                </label>
                            </div>
                        </div>

                        <div class="row">
                            <a id="btn-change-password" class="btn-flat right blue-text">GUARDAR</a>
                        </div>

                    </div>
                </li>
            </ul>

        </div>
    </div>
</div>

<script th:inline="javascript">
    var baseURL = /*[[@{/}]]*/ '/';
</script>
<script type="text/javascript">
    $(document).ready(function(){
        $('.collapsible').collapsible();


        $('#btn-modificar-datos').click(function(){

          var userDTO = {};
          userDTO.username = $('#username').val();
          userDTO.email = $('#email').val();


          modificarDatos(userDTO);

        });


        $('#btn-change-password').click(function(){

            var currentPassword = $('#currentPassword').val();
            var newPassword = $('#newPassword').val();
            var repeatedNewPassword = $('#repeatedNewPassword').val();

            if(newPassword !== repeatedNewPassword){
                alert('Las nuevas contraseñas no coinciden');
                return;
            }

            var changePasswordDTO = {};
            changePasswordDTO.currentPassword = currentPassword;
            changePasswordDTO.newPassword = newPassword;
            changePasswordDTO.repeatedNewPassword = repeatedNewPassword;

            changePassword(changePasswordDTO);

        });



    });


    function modificarDatos(userDTO){
        $.ajax({
            url: baseURL + 'editar-datos-usuario',
            method: 'POST',
            data: JSON.stringify(userDTO),
            contentType: 'application/json'
        })
            .done(function () {
                window.location.reload();
            })
            .fail(function (xhr, status) {
                var error = JSON.parse(xhr.responseText);
                console.log(error.msg);
            });
    }


    function changePassword(changePasswordDTO){

        $.ajax({
            url: baseURL + 'editar-password-usuario',
            method: 'POST',
            data: JSON.stringify(changePasswordDTO),
            contentType: 'application/json'
        })
            .done(function () {
                window.location.reload();
            })
            .fail(function (xhr, status) {
                var error = JSON.parse(xhr.responseText);
                console.log(error.msg);
            });
    }


</script>

</body>
</html>